#!/usr/bin/env bash
#
# ConceptDoc pre-commit hook
#
# Warns when a source file is staged without its .cdoc companion being updated.
# Does NOT block the commit — ConceptDoc is non-binding.
#
# Install: cp hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# Or use: bash hooks/install.sh

# File extensions to watch. Add or remove as needed for your project.
WATCHED_EXTENSIONS=("py" "js" "ts" "go" "rb" "java" "rs" "php")

# Build a regex pattern from the extensions list
ext_pattern=$(printf "|\.%s" "${WATCHED_EXTENSIONS[@]}")
ext_pattern="(${ext_pattern:1})$"

warnings=()

# Get all staged files
while IFS= read -r staged_file; do
  # Skip deleted files
  if ! git ls-files --error-unmatch "$staged_file" 2>/dev/null && \
     ! git diff --cached --name-only | grep -qx "$staged_file"; then
    continue
  fi

  cdoc_file="${staged_file}.cdoc"

  if [[ ! -f "$cdoc_file" ]]; then
    # .cdoc doesn't exist at all — suggest creating one
    warnings+=("  ⚠  $staged_file — no companion .cdoc found (consider creating $cdoc_file)")
  elif ! git diff --cached --name-only | grep -qx "$cdoc_file"; then
    # .cdoc exists but is not staged alongside the source change
    warnings+=("  ⚠  $staged_file was modified but $cdoc_file was not staged")
  fi

done < <(git diff --cached --name-only | grep -E "$ext_pattern")

if [[ ${#warnings[@]} -gt 0 ]]; then
  echo ""
  echo "╔─ ConceptDoc ──────────────────────────────────────────────────╗"
  echo "│ Some source files may need their .cdoc updated:               │"
  echo "╚───────────────────────────────────────────────────────────────╝"
  for w in "${warnings[@]}"; do
    echo "$w"
  done
  echo ""
  echo "  Run the sync-cdoc prompt to check what needs updating."
  echo "  Committing anyway — ConceptDoc hooks are warnings, not blockers."
  echo ""
fi

exit 0
